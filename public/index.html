<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CPU Scheduling Simulator</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #2c3e50; }
    label { display: block; margin-top: 10px; }
    select, input, button { margin-top: 5px; padding: 5px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    table, th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
    .gantt { margin-top: 20px; display: flex; }
    .gantt div { padding: 10px; border: 1px solid #444; margin-right: 2px; }
    pre { background: #f9f9f9; padding: 10px; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <h1>CPU Scheduling Simulator</h1>

  <label for="algo">Algorithm:</label>
  <select id="algo">
    <option value="fcfs">FCFS</option>
    <option value="sjf">SJF</option>
    <option value="srtf">SRTF</option>
    <option value="rr">Round Robin</option>
    <option value="priority">Priority</option>
  </select>

  <label for="n">Number of Processes:</label>
  <input type="number" id="n" value="3" min="1" />

  <div id="processInputs"></div>

  <button onclick="runSimulation()">Run Simulation</button>

  <h2>Results</h2>
  <div id="output"></div>

  <script>
    const processInputsDiv = document.getElementById("processInputs");

    document.getElementById("n").addEventListener("change", makeInputs);
    makeInputs();

    function makeInputs() {
      const n = parseInt(document.getElementById("n").value);
      processInputsDiv.innerHTML = "";
      for (let i = 1; i <= n; i++) {
        processInputsDiv.innerHTML += `
          <fieldset style="margin:10px 0;padding:10px;">
            <legend>Process ${i}</legend>
            Arrival: <input type="number" id="arrival${i}" value="0" min="0" />
            Burst: <input type="number" id="burst${i}" value="1" min="1" />
            <span id="extra${i}"></span>
          </fieldset>
        `;
      }
      updateExtraFields();
    }

    document.getElementById("algo").addEventListener("change", updateExtraFields);

    function updateExtraFields() {
      const algo = document.getElementById("algo").value;
      const n = parseInt(document.getElementById("n").value);
      for (let i = 1; i <= n; i++) {
        let extra = "";
        if (algo === "priority") {
          extra = ` Priority: <input type="number" id="priority${i}" value="1" min="1" />`;
        }
        document.getElementById(`extra${i}`).innerHTML = extra;
      }
    }

    async function runSimulation() {
      const algo = document.getElementById("algo").value;
      const n = parseInt(document.getElementById("n").value);

      let inputs = [n];
      for (let i = 1; i <= n; i++) {
        const arrival = parseInt(document.getElementById(`arrival${i}`).value);
        const burst = parseInt(document.getElementById(`burst${i}`).value);
        inputs.push(arrival, burst);

        if (algo === "priority") {
          const priority = parseInt(document.getElementById(`priority${i}`).value);
          inputs.push(priority);
        }
      }

      console.log("➡️ Sending request:", { algo, inputs });

      try {
        const res = await fetch("http://localhost:3000/run-cpp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ algo, inputs })
        });

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const data = await res.json();
        console.log("⬅️ Response:", data);
        displayResults(data);

      } catch (err) {
        document.getElementById("output").innerHTML = `<pre>❌ Fetch error: ${err}</pre>`;
      }
    }

    function displayResults(data) {
      if (data.error) {
        document.getElementById("output").innerHTML = `<pre>${data.error}\n${data.raw || ""}</pre>`;
        return;
      }

      let html = `<table><tr><th>PID</th><th>Arrival</th><th>Burst</th><th>Start</th><th>Completion</th><th>Waiting</th><th>Turnaround</th></tr>`;
      data.processes.forEach(p => {
        html += `<tr>
          <td>P${p.id}</td>
          <td>${p.arrival}</td>
          <td>${p.burst}</td>
          <td>${p.start}</td>
          <td>${p.completion}</td>
          <td>${p.waiting}</td>
          <td>${p.turnaround}</td>
        </tr>`;
      });
      html += `</table>`;

      html += `<p><b>Average Waiting Time:</b> ${data.avg_waiting.toFixed(2)}</p>`;
      html += `<p><b>Average Turnaround Time:</b> ${data.avg_turnaround.toFixed(2)}</p>`;

      // Simple Gantt Chart
      if (data.processes.length > 0) {
        html += `<h3>Gantt Chart</h3><div class="gantt">`;
        data.processes.forEach(p => {
          html += `<div>P${p.id}<br>${p.start}-${p.completion}</div>`;
        });
        html += `</div>`;
      }

      document.getElementById("output").innerHTML = html;
    }
  </script>
</body>
</html>
